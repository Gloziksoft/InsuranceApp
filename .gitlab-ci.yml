stages:
  - build_push
  - deploy

variables:
  # Globalne premenne pre referenciu
  IMAGE_NAME: registry.gitlab.com/gloziksoft/insuranceapp
  K8S_DEPLOYMENT: insurance-app

# ==============================================================================
# 1. OPRAVENÁ ETAPA: BUILD & PUSH (Riešenie Health Check a D-in-D zlyhania)
# ==============================================================================
build-and-push-job:
  stage: build_push
  tags:
    - docker
  image: docker:latest
  
  # KRITICKÉ: Použitie služby Docker-in-Docker (dind) s definovaným aliasom
  services:
    - name: docker:dind
      alias: docker # Definuje alias 'docker' pre službu, aby to fungovalo s DOCKER_HOST
    
  # KRITICKÉ: Premenné na správne pripojenie k D-in-D službe
  variables:
    DOCKER_HOST: tcp://docker:2375 # Povie Jobu, kde beží Docker démon (pod aliasom 'docker')
    DOCKER_TLS_CERTDIR: ""        # Zjednodušenie, ak nepoužívaš TLS
    
    # NOVÉ RIEŠENIE: Nariadi Runneru ignorovať zlyhanie zdravotnej kontroly (Health Check)
    FF_DISABLE_SERVICE_READY_CHECK: "true" 
    
  script:
    # Upozornenie: sleep 5 je teraz voliteľné, ale necháme ho pre vyššiu spoľahlivosť
    - echo "Waiting 5s for Docker daemon to stabilize..."
    - sleep 5
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHA .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHA

# ==============================================================================
# 2. ETAPA: DEPLOY (Zabezpečenie kubectl a k3s prístupu)
# ==============================================================================
deploy-to-k3s-job:
  stage: deploy
  image: alpine
  # DÔLEŽITÉ: Runner s tagom 'k3s' musí byť aktívny (čo sme riešili v config.toml)
  tags:
    - k3s
  before_script:
    # Inštalácia kubectl
    - apk add --no-cache curl git
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - mv ./kubectl /usr/local/bin/kubectl
    
    # Prístup ku Kubeconfig (ak Runner beží na k3s serveri)
    - cp /etc/rancher/k3s/k3s.yaml /tmp/kubeconfig.yaml
    - sed -i 's|https://127.0.0.1:6443|https://192.168.0.241:6443|g' /tmp/kubeconfig.yaml
    
  script:
    - export KUBECONFIG=/tmp/kubeconfig.yaml
    - 'sed -i "s|image:.*|image: ${IMAGE_NAME}:${CI_COMMIT_SHA}|" k8s/deployment.yaml'
    
    # Aplikácia zmien do K3s a kontrola stavu
    - kubectl apply -f k8s/deployment.yaml
    - kubectl rollout status deployment/$K8S_DEPLOYMENT --timeout=120s
    
  dependencies:
    - build-and-push-job